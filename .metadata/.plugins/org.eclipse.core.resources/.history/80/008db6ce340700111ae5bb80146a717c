package basicsofhibernate;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertNull;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.Persistence;

import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.product.Product;
import com.product.ProductCRUD;

public class ProductCrudTest {
    
    static EntityManagerFactory emf;
    EntityManager em;
    EntityTransaction et; // Don't initialize here!

    @BeforeAll
    public static void initEmf() {
        System.out.println("init emf");
        // Create the heavy factory once
        emf = Persistence.createEntityManagerFactory("postgres");
    }
    
    @BeforeEach
    public void initEM() {
        System.out.println("init em and et");
        // Create a fresh manager and transaction for EVERY test
        em = emf.createEntityManager();
        et = em.getTransaction();
    }

    @Test
    public void addProductTest1() {
        ProductCRUD crud = new ProductCRUD();
        
        Product p = new Product();
        p.setId(105);
        p.setName("Table");
        p.setPrice(8900);
        p.setQuantity(100);
        
        // Now et and em are not null
        String s = crud.addProducts(et, em, p);
        crud.deleteProductByID(et, em, 105);
        
        assertEquals("Data Added", s);
    }
    
    @Test
    public void addProductTest2() {
        ProductCRUD crud = new ProductCRUD();       
        Product p = null;
        String s = crud.addProducts(et, em, p);
        assertEquals("Data Empty", s);
    }
    
    @Test
    public void testFindByIDTest() {
        // This test now works because em is initialized in @BeforeEach
        
        ProductCRUD crud = new ProductCRUD();
        
        Product p = crud.findById(et, em,101);
        
        
        assertNotNull(p);
    }
    
    @Test
    public void testFindByID2() {
    	  ProductCRUD crud = new ProductCRUD();
          
          Product p = crud.findById(et, em,104);
          
          
          assertNull(p);
    }
    
    @Test
    public void deleteById1() {
    	
    	ProductCRUD crud = new ProductCRUD();
        
        Product p = new Product();
        p.setId(103);
        p.setName("Chair");
        p.setPrice(15000);
        p.setQuantity(50);
        
        
        crud.addProducts(et, em, p);
        
        Product del = crud.deleteProductByID(et, em, 103);
        
        assertNotNull(del);
 	
    }
    @Test
    public void deleteById2() {
    	ProductCRUD crud = new ProductCRUD();
    	
    	Product del = crud.deleteProductByID(et, em, 104);
    	 
    	assertNull(del);
    	
    }
    
    @AfterEach
    public void destroyEM() {
        System.out.println("em closing");
        if (em != null && em.isOpen()) {
            em.close();
        }
    }
    
    @AfterAll 
    public static void destroyEMF() {
        System.out.println("emf closing");
        if (emf != null && emf.isOpen()) {
            emf.close();
        }
    }
}