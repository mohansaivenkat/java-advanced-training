package basicsofhibernate;

import static org.junit.jupiter.api.Assertions.assertNotNull;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.EntityTransaction;
import javax.persistence.Persistence;

import org.junit.jupiter.api.AfterAll;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import com.product.Product;
import com.product.ProductCRUD;

public class ProductCrudTest {
    
    static EntityManagerFactory emf;
    EntityManager em;
    EntityTransaction et; // Don't initialize here!

    @BeforeAll
    public static void initEmf() {
        System.out.println("init emf");
        // Create the heavy factory once
        emf = Persistence.createEntityManagerFactory("postgres");
    }
    
    @BeforeEach
    public void initEM() {
        System.out.println("init em and et");
        // Create a fresh manager and transaction for EVERY test
        em = emf.createEntityManager();
        et = em.getTransaction();
    }

    @Test
    public void addProductTest() {
        ProductCRUD crud = new ProductCRUD();
        
        Product p = new Product();
        p.setId(102);
        p.setName("Powder");
        p.setPrice(90);
        p.setQuantity(100);
        
        // Now et and em are not null
        crud.addProducts(et, em, p);
        
        Product found = em.find(Product.class, 102);
        assertNotNull(found);
    }
    
    @Test
    public void testFindByIDTest() {
        // This test now works because em is initialized in @BeforeEach
        Product p = em.find(Product.class, 101);
        assertNotNull(p);
    }
    
    @AfterEach
    public void destroyEM() {
        System.out.println("em closing");
        if (em != null && em.isOpen()) {
            em.close();
        }
    }
    
    @AfterAll
    public static void destroyEMF() {
        System.out.println("emf closing");
        if (emf != null && emf.isOpen()) {
            emf.close();
        }
    }
}